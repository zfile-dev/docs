# 捐赠版更新日志

:::tip
购买捐赠版可以上 https://www.zfile.vip/pricing 查看功能介绍并购买.
:::


## 4.2.3

### 优化
1. 优化存储源必填提示文字为中文.
2. 完善规则管理页面的提示信息

### BUG 修复
1. 修复移动端首页设置按钮不显示的 bug
2. 修复用户密码无法修改的 bug
3. 修复 Google Drive 某些情况下返回刷新令牌为空的 bug
4. 修复 S3 存储类型新建文件夹或上传文件夹失败的bug
5. 修复升级到 4.2.2 版本后 Webdav 无法使用的 bug
6. 修复 minio 使用域名时，默认为域名风格地址导致无法下载的 bug
7. 修复用 OnlyOffice 预览过某个文件后，删除或重新上传本地修改过的文件时，仍然看到旧版本的 bug
8. 修复保存的用户规则重启后失效的 bug
9. 完善 "上传规则应用至重命名" 功能的说明和功能
10. 修复未保存的规则进行测试时始终提示不匹配的 bug

## 4.2.2

### 新功能
- 增加移动端布局指定。
- 新增记住密码功能。
- 支持自定义 office 预览的文件后缀。
- 支持强制设置匿名用户显示内容。

### BUG 修复
- 修复错误使用代理下载限速作为代理下载过期时间的 bug。
- 修复 2fa 页面首次打开自动保存 bug
- 修复从 "内容变更前隐藏弹窗公告" 的存储源切换其他存储源时，闪一下的 bug。
- 修复移动端面包屑某些情况下不刷新的 bug。

### 优化
- 优化密码文件夹匹配性能

## 4.2.1

### 新功能

1. 增加规则管理功能：可限制不同用户上传/显示文件的功能。
2. 大幅优化移动端体验。（后台管理）
3. 新的图标模式视图（前台顶部栏点击设置按钮切换）

### BUG 修复
1. 修复苹果手机  qq 和微信浏览器长按不弹出菜单的 bug
2. 修复 cors 跨域配置异常的bug
3. 修复密码文件夹规则包含通配符时，无法保存的 bug
4. 修复 od 个人版移动、复制文件失败的 bug（api 不同，个人版必须要传递目标文件夹 id）

### 优化
1. 优化右键菜单显示效果
2. 增强存储源配置校验

## 4.2.0

> 注意，此版本为一次大版本更新，虽然已经测试过很多轮，但仍然可能存在未知问题，追求稳定可以先观望下或等下个版本相对稳定后再升级。

> - 如果要升级，请先备份好数据！
> - 如果要升级，请先备份好数据！
> - 如果要升级，请先备份好数据！

> 更新方式已经兼容为和以前一样，具体可参见文档左侧[捐赠版安装/更新](/install-pro)

### 新功能
- 多用户功能
- 登录日志功能
- 访问控制功能
- 存储源均支持服务器中转下载、限速
- Webdav 支持上传、删除、重命名等功能（beta）
- 支持移动、复制文件、文件夹功能
- OnlyOffice 支持在线编辑，协同编辑，支持 JWT Token 验证

### 优化
- 大幅优化服务启动性能(5 倍以上，不含存储源本身初始化时间)
- 管理员模块页面优化，功能分组设计，方便管理
- 直链、短链页面上分开获取，避免之前的歧义
- 视频、PDF、Office、3D、纯文本文件预览支持全屏显示
- 更换纯文本预览组件，提高页面加载速度
- 纯文本预览支持自动识别文件编码

### BUG
- 修复修改直链别名后需重启服务才生效的 bug
- 修复苹果设备 safari 上长按无法弹出右键菜单的问题 (然后删除了悬浮菜单功能)


> 暂时只想到这些更新点，但实际上还有很多优化和 bug 修复，之后会慢慢补充到文档。


## 4.1.6

### 新功能
- zfile 捐赠版未填写或授权错误提示信息优化 (捐赠版)
- referer 防火墙表达式在线测试功能
- 复制存储源功能
- 短链增加有效期功能 (可在 "直/短链设置" 中修改短链有效期)
- 支持自定义 title 和 favicon 功能，返回的 html 是已经修改过的，不是等待页面加载完再修改。
- 密码文件夹支持选择是否记住密码(默认不记住密码,可在后台 "显示设置" 中修改)

### 优化
- 优化打包下载因配置不当导致无法下载的提示（捐赠版）
- 优化 referer 黑白名单校验表达式提示信息
- 优化路径直链功能，不再使用全局过滤器实现，而是使用动态 Controller 实现
- 修正下载日志中时间描述歧义
- 自定义 confirm 和 prompt 组件
- 完善本地存储路径校验功能，提示必须输入绝对路径
- 修改 "是否允许使用直链" 功能描述

### BUG
- 修复 webdav 管理页面错误弹窗的 bug (捐赠版)
- 修复直短链下载响应头问题，导致安卓手机下载 apk 时自动变 zip 的问题
- 修复多吉云令牌无法自动刷新的 bug
- 升级依赖版本，修复安全漏洞
- 修复从存储源根目录回退到存储源列表时，首页仍然显示了底部文档的 bug。
- 修复从后台点击 logo 回到前台时，面包屑可能异常的 bug
- 修复视频播放器某些情况无法识别字幕的 bug
- 修复苹果系设备上移动端后台菜单错误的 bug
- 修复某些情况下无限重定向的 bug
- 修复本地存储某些情况下安全性 bug

## 4.1.5

### 新功能

- 支持区分预览和下载的权限 （捐赠版）
- 新增存储源[多吉云](https://www.dogecloud.com/?iuid=886)支持
- 新增卡片布局模式
- 增加加载更多功能，优化大文件夹加载速度，支持设置每页初始最多显示文件数及每次加载更多文件数  [#468](https://github.com/zfile-dev/zfile/issues/468)
- 增加首页 logo 显示功能
- 增加设置默认排序字段和排序方向的功能
- 视频播放器开启 airplay 功能（如果设备支持）
- 新增批量按条件删除直链下载日志功能
- 增加直链单位时间内单 IP 最大下载次数限制功能

### 优化
- 优化后端自动校验域名是否设置正确的功能，不使用强弹窗提示，而是在后台设置页面显示提示信息。
- 优化面包屑功能，支持根据页面宽度自动折叠部分面包屑
- hls 视频播放不再依赖直链，而是使用自定义解析器获取文件实际直链，解决了部分视频无法播放的问题
- 修改 referrer 策略，修改为同源的才发送 referrer，其他的不发送。
- 优化直链 Referer 黑/白名单域名输入框提示信息，提示需要输入协议头
- 为了安全性，去除从服务器加载文本文件的功能。
- 移动端视频播放非全屏状态下，隐藏网页全屏按钮，避免工具类宽度不足问题
- 更换 flv.js 为 mpegts.js 播放器，提高性能
- 增强自定义 js 功能，支持更多场景
- 更显眼的提示 Google Drive 需要自建 API 应用才能使用
- 更显眼的提示用户腾讯云使用 CDN 回源鉴权后需要关闭 ZFile 中私有空间开关。

### BUG
- 修复搜索文件后，点击面包屑无法返回的 bug  （捐赠版）
- 修复存储源别名修改后再修改回去提示占用的 BUG
- 修复本地存储上传文件后，未解除文件占用的 BUG
- 修复上传文件夹时，实际上传后的文件路径错乱的 BUG   [#485](https://github.com/zfile-dev/zfile/issues/485)
- 修复文件夹上传时，当文件进入队列后，切换到其他目录，队列中的文件上传目录会变化的 BUG.
- 修复某些分辨率下，文件前的图标被遮挡的 bug
- 修复右键菜单在存储源为空时无效的 bug
- 修复存储源为空时文件区域高度异常问题
- 修复调用 potplayer 播放视频时文件名中包含中文报错的 bug
- 修复短链对应的存储源关闭后，存储源仍然可以访问的 bug
- 修复自动设置 CORS 时，某些 S3 兼容性不同导致的 BUG（BackBlaze 不支持 * 和实际域名写到一起，不支持空值）
- 修复 Google Drive 中的快捷方式文件夹无法正常显示的 bug
- 修复未控制并发为同一文件生成了多条短链的 bug
- 修复七牛对私有空间使用自定义域名后无法正常下载的 bug

## 4.1.4

### 优化

- 优化存储源列表在移动端容易误触拖动的问题，在移动端增加长按 300 耗秒延迟，使得可以长按拖动。
- OneDrive、SharePoint 上传大小为 0 的文件时，直接提示失败，不支持上传空文件。
- 去除初始化页面和后台站点设置页面对于站点域名字段的校验，允许用户输入任意值（为了支持 IPV6 地址）。
- 密码、过滤、目录文档中的规则表达式自动 trim 前后空格，防止勿输入空格导致不可用。
- 增强 SharePoint 存储源的提示，提示网站隐私设置需为 "公用-组织中的任何人都可访问此站点" 时才能正常使用。
- 优化代码，提供系统稳定性。

### BUG

- 修复本地存储上传、删除等文件操作，可能存在越权获取到上级目录的 bug.
- 修复后台设置直链 Referer 防盗链不生效的 bug.
- 修复加密文件夹在未输入密码时，显示了目录文档的 bug
- 修复上传时，排队中的任务因目录切换导致恢复排队后上传到当前所在目录的 bug
- 修复本地存储文件夹大小显示错误的 bug
- 修复 404，403，401 页面显示异常的 bug
- 修复自定义 js 功能，面对多个 script 标签无法正常加载的 bug
- 修复对单个文件生成直链时，导致列表上文件大小显示异常的 bug
- 修复本地存储无法上传大小为 0 的 bug

## 4.1.3

### BUG

- 修复加了密码的文件夹无法正常删除、重命名等操作的 BUG  **（4.1.2 Pro 版本引起，建议升级到 4.1.3 Pro）**
- 修复部分存储源根目录无法文件操作的 BUG**（4.1.2 Pro 版本引起，建议升级到 4.1.3 Pro）**
- 修复更新存储源设置第二次保存才会生效的 BUG **（4.1.2 Pro 版本引起，建议升级到 4.1.3 Pro）**
- 修复支持显示文件夹大小的存储类型未显示的 BUG
- 修复在 Linux 下开启后台登录图片验证码时，出现异常提示的 BUG

## 4.1.2

### 新功能

- 服务器中转下载的直链支持手动添加 `type=preview` 来改变直链的默认下载行为。如直链是图片，访问 `http://127.0.0.1:8080/directlink/image.png` 默认为下载，访问 `http://127.0.0.1:8080/directlink/local/image.png?type=preview` 则为预览（浏览器支持的话）
- 新增功能，可控制未生成的路径直链是否允许访问，如直链为：`http://127.0.0.1:8080/directlink/local/image.png` ，该文件未生成直链，是否允许直链访问，设置位置在后台： `直链管理 -> 直链设置 -> 是否允许路径直链可直接访问`。
- 弹窗模式目录文档增加选项，支持控制是否不在显示功能（仅对确认的目录生效，且这个目录公告变更后会再次提示）
- 视频在线预览下方工具类支持隐藏

### 优化

- 📱浏览器兼容性增强，经测试最低支持到 `谷歌 49+`、`Firefox 51+`、`Android 7.0+` ，不支持 IE 任何版本。
- 👨‍💻 优化代码结构，更加规范
- 🗒 优化日志输出，便于出现问题时快速定位
- ⚡️ 优化缓存功能，避免频繁查询数据库，提高查询效率
- 🔐 安全性提升，所有文件操作，都校验文件夹密码。

### BUG

- 修复新增存储源失败后，再次新增其他类型的存储源类型失败的 BUG
- 修复某些情况下会显示 `[SQLITE_BUSY]  The database file is locked (database is locked)` 的 BUG。
- 修复删除存储源后，没有同步删除其他相关资源的 BUG（如直链、下载日志、过滤规则、密码规则等）
- 修复目录密码、目录文档规则表达式某些情况未生效的 BUG。
- 修复目录密码某些情况下前端未自动缓存导致一直提示手动输入的 BUG。
- 修复 S3 协议存储源只能展示同目录下前 1000 个文件的 BUG
- 修复新增加的存储源顺序不在最前面的 BUG
- 修复捐赠版 linux 启动脚本某些情况未成功加载项目目录下配置文件的 BUG
- 修复直链页面显示大小异常的 BUG
- 修复弹窗模式的 readme 文档内容较多时不显示滚动条的 BUG
- 修复未添加任何存储源时，debug 模式也无法重置密码的 BUG
- 修复存储源删除后，直链页面无法打开的 BUG
- 修复没有传递 origin 时，无法正常跨域的 bug
- 修复 `Cloudflare R2` 和 `Oracle R2` 无法正常添加问题
- 修复 S3 存储类型域名风格无法选择问题。
- 修复部分情况下文件夹大小未显示的 bug

## 4.1.1

### 新功能

* 3d 文件使用直链加载，且支持背景颜色选择器。

### 优化

- 自定义 js 修改为页面加载完才执行，防止获取不到元素的情况。
- 上传弹窗下也支持 ctrl + v 粘贴上传
- 修改系统设置 value 值字段类型为 text, 防止自定义 js css 过长无法保存

### BUG

- 修复某些情况拖拽无效的 bug

- 修复直接截图到剪贴板的图片无法直接粘贴上传的 bug

- 修复 3d 某些情况无法正常加载的问题。

- 修复首次安装 zfile 时没有自动创建数据库目录的 bug

### 捐赠版

- 直链排行日志 - 文件，支持显示存储源 key 和文件路径

## 4.1.0

### 新功能

* Google Drive 支持
* 支持 Office 预览功能，如 `excel`，`ppt`，`word` 使用 OnlyOffice 实现，支持自建服务。
* 支持 3d 文件预览，如 'dae', 'fbx', 'gltf', 'glb', 'obj', 'ply', 'stl' 格式，`obj` 格式的还会自动检测同目录同名的 `mtl ` 纹理文件。
* 支持 WebDAV 功能（捐赠版），目前仅支持只读操作，后续会支持上传，删除等功能。

### 优化

- 后台直链列表和统计页面支持复制直链和打开直链功能
- 增加校验，直链前缀不可为空
- OneDrive/SharePoint/Google Drive 动态提示自定义 api  时需要填写的回调地址，且支持复制。
- OneDrive/SharePoint/Google Drive 获取令牌链接支持复制
- 上传页面增加 `已上传大小/总大小` 显示
- 优化批量生成直链功能，保证生成顺序，且只需要调用一次后台，避免批量生成直链时触发 cc
- 优化批量删除功能，且只需要调用一次后台，避免批量删除时触发 cc
- 批量生成直链后，支持批量复制名称功能

### BUG

- 修复批量生成直链顺序混乱的 BUG

- 修复某些 `4.0.8` 及以前的版本使用 zfile 默认 api 获取访问令牌时可能会报错的 bug

## 4.0.10

### 新功能

批量下载和打包下载授权功能，授予管理员/匿名用户是否可用

### 优化

- 未填写备案信息时, footer 不显示.
- 优化 OneDrive/SharePoint 获取 token 体验，增加信息显示，并优化页面效果。
- 打包下载增加 loading
- 打包下载时，其中一个文件错误，则取消打包并提示错误文件.

### BUG

- 修复 SharePoint 世纪互联自定义 api 失败的 bug
- 修复 OneDrive/SharePoint 自定义 api 时 clientSecret 包含特殊字符时异常的 bug
- 修复兼容读取 readme.md 模式仅启动后首次设置有效的 bug

<div className={'divider'}></div>

## 4.0.9

### 新功能

- ✨ 增加目录文档兼容模式，如启用该功能，则忽略规则模式，而是读取目录下 `readme.md` 文件，并显示在文件列表下方显示
- ✨ 增加最大同时上传数限制
- ✨ **ZFile Pro 特有功能** 增加打包下载功能（仅兼容谷歌浏览器）
- ✨ 新增同时上传文件数量限制, 新增上传失败重试功能，新增删除等待中和已完成任务功能

### 优化

- ✨完善 `OneDrive` `SharePoint` 自定义 `clientId` 、`clientSecret`、`redirectUri` 功能体验.
- ✨ 优化后台存储源列表页面, 更易于操作
- ✨ 优化上传页面样式，更加美观.
- 因浏览器特性兼容性，批量下载或打包下载时判断当前浏览器，提示推荐使用谷歌浏览器。
- 优化自定义 js 功能，支持写 `<script></script>` 标签也可不写，解析时会自动兼容.
- 优化代码，修改配置信息默认值，并使 `zfile.config.json` 可配置前台设置默认值，如移动端默认画廊列数、画廊列间距、行间距等功能
- 优化画廊模式列间距功能, 避免大于 1 列且设置了列间距的情况下, 最后一列的右侧也会显示空白间距.
- 当未上传完成时，增加 `badge` 显示未上传完成数量.
- 上传需要服务器中转的文件时，如 ftp、sftp、webdav 时提示服务器中转中.
- 浏览器控制台增加浏览器信息输出, 便于问题发现和排查
- 增加文件页文字宽度和粗度, 易于浏览
- 完善存储源别名填写时对系统默认关键字的检测, 如为系统关键词, 则不允许设置为存储源别名
- 优化后台日志下载功能，增加 loading, 防止日志文件过大时导致看起来没反应的问题。

### BUG

- 修复批量删除直链或直链下载日志数量过多时, 无法正常删除的问题。

- 修复右键菜单点击空白处失败的 bug
- 修复默认打开画廊模式失败的 BUG.
- 修复右键菜单在错误的地方（如 dialog）显示的 bug

<div className={'divider'}></div>

## 4.0.8

### 新功能

- 支持右键文件区空白处（非 header 和 footer 部分）新建文件夹、上传文件、上传文件夹
- 右键菜单支持刷新按钮
- **PDF 预览功能，支持按 + - 放大缩小，支持按 ← → 切换页码（非显示全部页码状态下）**

### 优化

- 完善 OneDrive SharePoint 反代域名参数的描述信息
- 统一本地存储、sftp、ftp、webdav 下载文件 contentType 为 application/octet-stream, 避免浏览器自动进行默认预览动作
- 完善删除文件、文件夹操作体验，区分删除的是一个还是多个。区分当前存储源是否支持删除非空文件夹
- 完善存储源添加时校验，如果 zfile 站点是 https 的，则提示不允许添加 http 协议的加速域名.
- 重构部分代码, 优化组件间的引用关系
- 修复拖拽上传和粘贴上传失效的 bug
- 优化移动端视频弹窗、文本弹窗、图片预览的兼容性问题
- 优化移动端视频播放器切换上一个下一个逻辑
- 优化 minio 提示信息

### BUG

- 修复 IOS 浏览器下画廊模式无法点击预览的 BUG
- 修复 Safari 浏览器某些文件类型无法正常下载的 BUG
- 修复 m3u8 无法正常播放的 BUG
- 修复兼容 h5ai_dplayer 时，如果切片目录隐藏，导致无法正常加载的 BUG
- 修复获取 m3u8 直链后系统报错的 bug.
- 修复默认打开画廊模式失败的 BUG.
-

<div className={'divider'}></div>

## 4.0.7

### 新功能

- 兼容 h5ai_dplayer https://github.com/Pearlulu/h5ai_dplayer：如同目录下有 `__{video_name}__` 则取 `__{video_name}__/video.m3u8`

### 优化

- 优化 S3 协议自动配置跨域逻辑，改为不覆盖原有配置。且增加 GET 跨域，对于在线预览文本、视频场景提供跨域支持.
- 优化图片预览使用体验，默认预览图片支持左右切换
- 画廊模式重新支持懒加载
- 移动端适配：优化文件页移动端布局，改为右上角点击显示所有功能
- 移动端适配：优化登录和初始化页面移动端体验.
- 移动端适配：优化移动端消息提示和弹窗确认/弹窗输入框体验
- 移动端适配：优化移动端布局，管理后台表单元素支持换行.
- 移动端适配：优化移动端布局，移动端所有 dialog 弹窗宽度设置为 90%
- 移动端适配：优化后台管理移动端布局，下级后弹出所有功能菜单
- 移动端适配：优化管理后台 header 部分布局, 兼容移动端
- 代码优化，解除未来 jdk 版本对过期内容的引用

### BUG

- 修复画廊模式下点击无法预览的 BUG
- 修复文件列表某些情况最后一个文件会被挡住的 bug, 且会有两个滚动条，影响使用体验  #390   #393
- 修复 minio 设置跨域上传报错的 bug

<div className={'divider'}></div>

## 4.0.6

### 新功能

- 独立直链和短链功能，短链不再依赖直链，可单独启用
- 支持权限设置： 是否可用、忽略密码、忽略隐藏

### 优化

- 修复本地存储文件路径描述，对于 docker 环境更容易理解。
- 优化使用体验，移动端画廊模式默认为 1 列
- 优化视频、文本、文档等异步组件首次加载卡顿问题, 增加骨架屏.
- 优化移动端视频弹窗宽度
- 修复搜索框无法粘贴问题

### BUG

- 修复腾讯云 cos 对象存储，无法自动加载账号下的所有存储器列表的 bug
- 修复长图片被拉伸的 bug
- 修复调用播放器 potplayer 时，链接中包含中文导致无法播放的 bug.
- 修复部分情况 ctrl + v 控制台报错的 bug
- 暂时关闭图片懒加载, 待完美解决后再次开放.

<div className={'divider'}></div>

## 4.0.5

这是第一个捐赠版版本，在开源社区版基础上支持文件搜索、下载限制、权限控制、统计分析功能